# 此宏最初由 Discord 用户 Garrettwp 提供，作者对其进行了大量优化。
# 它基于 Annex Engineering 的 MagProbe 可 docking 探针宏（原作者：Mental，后由 RyanG 和 Trails 为 K 系列打印机改进）。
# 该宏现已演变为一个 Klipper 插件（Quickdraw_Probe），正在等待合并入 Klipper 主线。
# 用户 richardjm 对变量进行了重构并新增功能，特此致谢。
# 站在巨人的肩膀上，我们希望能看得更远！
#
# 当前 Klicky 版本维护地址：https://github.com/jlas1/Klicky-Probe
# 注：下方所有设为 1000 的值是为了在未正确配置时触发错误（而非执行危险动作），
#      假设你的打印机不会超过 1 米尺寸。

[gcode_macro _User_Variables]

# ====== 基础行为控制 ======
variable_verbose:             True    # 启用详细输出（在终端显示操作步骤）
variable_debug:              False    # 启用调试输出（更详细的内部状态，一般用户无需开启）

# ====== 运动参数 ======
variable_travel_speed:         200    # 所有非关键移动（如前往挂座）的速度（mm/min）
variable_move_accel:          1000    # 工具头移动时的加速度（mm/s²）
variable_dock_speed:            50    # 探针“入座”（dock）时的最后靠近速度（较慢，避免撞击）
variable_release_speed:         75    # 卸载探针后，微移释放磁吸的移动速度
variable_z_drop_speed:          20    # Z 轴下降到安全高度以避开探针时的速度（较慢，防撞）

# ====== 安全高度设置 ======
variable_safe_z:               25     # 执行挂载/卸载/归零等操作时的最小 Z 高度（mm）
                                    # 必须高于打印床和任何障碍物

variable_enable_z_hop:        True    # 若 Z 未归零，是否先抬升喷嘴再移动？
                                    # 设为 False 适用于床板在断电后会大幅下坠的打印机（如某些 CoreXY）

# ====== 打印床尺寸限制（用于 probe_accuracy 安全检查）======
variable_max_bed_x:           120     # 打印床最大 X 尺寸（mm），防止探针移出床面
variable_max_bed_y:           120     # 打印床最大 Y 尺寸（mm）

# ====== Z 轴归零位置（用于 safe_z_home）======
# 如果你使用独立的 Z 限位开关（如 Voron 的顶部开关），填写其坐标；
# 若使用探针作为 Z 限位，则设为 0，系统会自动使用床中心。
variable_z_endstop_x:        1000     # Z 限位开关 X 坐标（设为 1000 表示未配置）
variable_z_endstop_y:        1000     # Z 限位开关 Y 坐标

# ====== 探针挂载座（Dock）位置 ======
# 这些是探针挂座在打印机坐标系中的绝对位置（单位：mm）
# ⚠️ 必须根据你的实际安装修改！默认 1000 是为了强制报错提醒你配置
variable_docklocation_x:     1000     # 挂座 X 坐标（例如：10）
variable_docklocation_y:     1000     # 挂座 Y 坐标（例如：340）
variable_docklocation_z:     -128     # 挂座 Z 坐标：
                                    #   -128 表示挂座固定在龙门架/框架上（Z 与喷嘴联动）
                                    #   若挂座在打印床上（随床移动），则设为实际 Z 高度（如 0）

# ====== 伺服电机控制挂座（可选）======
variable_enable_dock_servo: False    # 是否使用伺服电机控制挂座伸缩？
variable_servo_name:       'NAME'    # 伺服名称，需与 printer.cfg 中 [servo your_name] 一致
variable_servo_deploy:        10     # 伺服“伸出”角度（挂探针时）
variable_servo_retract:       11     # 伺服“缩回”角度（打印时）
variable_servo_delay:        250     # 伺服动作后等待时间（毫秒），确保到位

# ====== 挂载/卸载的微调移动（相对移动）======
# 这些是挂载或卸载探针时，最后一步的微小相对移动（用于精确对准磁吸）
# 通常只需调整 X 方向（因磁吸有导向斜面）
Variable_dockmove_x:         1000     # 卸载后，向 +X 微移释放磁吸（必须修改！例如：5）
Variable_dockmove_y:            0     # Y 方向微移（通常为 0）
Variable_dockmove_z:            0     # Z 方向微移（通常为 0）

Variable_attachmove_x:       1000     # 挂载前，向 -X 微移以对准（必须修改！例如：-5）
Variable_attachmove_y:          0
Variable_attachmove_z:          0

# ====== 线缆管理（Umbilical）======
variable_umbilical:         False    # 是否启用“线缆理顺”动作（防止探针线缠绕）
variable_umbilical_x:          15    # 理顺动作的 X 位置
variable_umbilical_y:          15    # 理顺动作的 Y 位置

# ====== 工具头停放位置 ======
variable_park_toolhead:     False    # 归零或调平后是否自动停放工具头？
variable_parkposition_x:     125     # 停放 X 坐标
variable_parkposition_y:     125     # 停放 Y 坐标
variable_parkposition_z:      30     # 停放 Z 高度；若设为 -128，则仅移动 X/Y，不控制 Z

# ====== 版本控制（用于更新提示）======
variable_version:              1     # 配置版本号，便于后续更新检查

# ========== 以下通常无需用户修改 ==========

# 挂载第二步微调（高级用途，一般设为 0）
Variable_attachmove2_x:         0
Variable_attachmove2_y:         0
Variable_attachmove2_z:         0

# 归零后回退距离（避免限位开关卡死，尤其 Voron V0 需要）
variable_home_backoff_x:       10     # X 归零后回退 10mm
variable_home_backoff_y:       10     # Y 归零后回退 10mm

# 强制指定归零顺序（默认自动避让挂座）
variable_override_homing:     ''      # '' = 自动；'X' = 先归 X；'Y' = 先归 Y

# Z 归零时是否自动卸载探针（避免探针撞床）
variable_dock_on_zhome:      True    # 推荐保持 True

# 调试用：跳过探针挂载/卸载（危险！仅用于测试）
variable_bypass_probe_docking: False

# ========== 自动计算部分（不要手动修改）==========
gcode:
    # 从 printer.cfg 中读取打印机最大行程和探针偏移
    {% set Mx = printer['configfile'].config["stepper_x"]["position_max"]|float %}
    {% set My = printer['configfile'].config["stepper_y"]["position_max"]|float %}
    {% set Ox = printer['configfile'].config["probe"]["x_offset"]|float %}
    {% set Oy = printer['configfile'].config["probe"]["y_offset"]|float %}
    {% set Oz = printer['configfile'].config["probe"]["z_offset"]|float %}

    # 如果用户设置了 Z 限位坐标（非 0），则直接使用
    {% if z_endstop_x != 0 or z_endstop_y != 0 %}
        SET_GCODE_VARIABLE MACRO=_Probe_Variables VARIABLE=z_endstop_x VALUE={ z_endstop_x }
        SET_GCODE_VARIABLE MACRO=_Probe_Variables VARIABLE=z_endstop_y VALUE={ z_endstop_y }
    # 否则，自动计算床中心作为 Z 归零点（考虑探针偏移）
    {% else %}
        SET_GCODE_VARIABLE MACRO=_Probe_Variables VARIABLE=z_endstop_x VALUE={ (Mx * 0.5) - Ox }
        SET_GCODE_VARIABLE MACRO=_Probe_Variables VARIABLE=z_endstop_y VALUE={ (My * 0.5) - Oy }
    {% endif %}